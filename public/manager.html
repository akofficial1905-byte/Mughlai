<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mughlai Point — Manager Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Inter, system-ui, sans-serif; }

    .order-type-badge {
      font-size:12px;font-weight:bold;border-radius:7px;padding:4px 10px
    }
    .order-type-dinein { background:#fbbf24;color:#222 }
    .order-type-takeaway { background:#34d399;color:#222 }
    .order-type-delivery { background:#60a5fa;color:#fff }

    .order-card{border-radius:14px;padding:16px}

    @media(max-width:768px){
      .desktop-only{display:none}
    }
  </style>
</head>

<body class="bg-gradient-to-b from-slate-900 via-gray-900 to-black text-gray-100 min-h-screen">

<div class="max-w-7xl mx-auto p-4">

  <!-- HEADER -->
  <header class="mb-6">
    <h1 class="text-3xl font-extrabold text-amber-300">Mughlai Point — Manager</h1>
    <p class="text-sm text-gray-400">Live Orders • Dashboard • Printing</p>
  </header>

  <!-- TABS -->
  <div class="flex gap-2 mb-6">
    <button id="tabOrders" class="bg-amber-400 text-black px-4 py-2 rounded font-bold">Orders</button>
    <button id="tabAnalytics" class="bg-gray-700 px-4 py-2 rounded font-bold">Analytics</button>
  </div>

  <!-- ================= ORDERS ================= -->
  <div id="ordersSection">

    <div class="bg-gray-800 rounded-xl p-4 mb-4 flex flex-col sm:flex-row justify-between gap-4">
      <div>
        <label class="text-sm text-amber-300 font-bold">Select Date</label>
        <input id="datePicker" type="date"
          class="bg-yellow-50 text-black font-bold p-2 rounded mt-1">
      </div>
      <div class="text-sm">
        <div>Total Orders: <span id="totalOrders" class="text-amber-300 font-bold">0</span></div>
        <div>Revenue: ₹<span id="totalRevenue" class="text-green-300 font-bold">0</span></div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section>
        <h2 class="text-xl font-semibold text-yellow-200 mb-4">Incoming Orders</h2>
        <div id="incoming" class="space-y-4"></div>
      </section>
      <section>
        <h2 class="text-xl font-semibold text-green-300 mb-4">Delivered Orders</h2>
        <div id="delivered" class="space-y-4"></div>
      </section>
    </div>
  </div>

  <!-- ================= ANALYTICS ================= -->
  <div id="analyticsSection" style="display:none">

    <!-- DASHBOARD (ORIGINAL LOGIC) -->
    <section class="bg-white rounded-xl p-6 mb-8 shadow border">
      <div class="flex flex-wrap gap-4 items-center mb-4">
        <select id="dashboardPeriod" class="border p-2 rounded font-bold">
          <option value="day">Day</option>
          <option value="week">Week</option>
          <option value="month">Month</option>
        </select>
        <input id="dashboardDate" type="date" class="border p-2 rounded font-bold">
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-amber-50 p-4 rounded text-center">
          <div id="sales-today" class="text-xl font-bold text-amber-700">₹0</div>
          <div class="text-sm">Sales</div>
        </div>
        <div class="bg-green-50 p-4 rounded text-center">
          <div id="orders-month" class="text-xl font-bold text-green-700">0</div>
          <div class="text-sm">Orders</div>
        </div>
        <div class="bg-blue-50 p-4 rounded text-center">
          <div id="peak-hour" class="text-xl font-bold text-blue-700">-</div>
          <div class="text-sm">Peak Hour</div>
        </div>
        <div class="bg-red-50 p-4 rounded text-center">
          <div id="top-dish" class="text-xl font-bold text-red-700">-</div>
          <div class="text-sm">Top Dish</div>
        </div>
      </div>
    </section>

    <!-- INSIGHTS -->
    <section class="bg-white rounded-xl p-6 shadow">
      <h3 class="text-xl font-bold mb-4 text-yellow-800">Detailed Insights</h3>
      <div id="insightResult"></div>
    </section>

  </div>
</div>

<script>
/* ================= SOCKET ================= */
const socket = io();

/* ================= TAB SWITCH ================= */
const tabOrders=document.getElementById('tabOrders');
const tabAnalytics=document.getElementById('tabAnalytics');
const ordersSection=document.getElementById('ordersSection');
const analyticsSection=document.getElementById('analyticsSection');

tabOrders.onclick=()=>{
  ordersSection.style.display='block';
  analyticsSection.style.display='none';
  tabOrders.className='bg-amber-400 text-black px-4 py-2 rounded font-bold';
  tabAnalytics.className='bg-gray-700 px-4 py-2 rounded font-bold';
};
tabAnalytics.onclick=()=>{
  ordersSection.style.display='none';
  analyticsSection.style.display='block';
  tabAnalytics.className='bg-amber-400 text-black px-4 py-2 rounded font-bold';
  tabOrders.className='bg-gray-700 px-4 py-2 rounded font-bold';
};

/* ================= ORDERS ================= */
const datePicker=document.getElementById('datePicker');
datePicker.value=new Date().toISOString().slice(0,10);

async function fetchOrders(date){
  const res=await fetch('/api/orders?date='+date);
  const orders=await res.json();
  renderOrders(orders);
}

function renderOrders(orders){
  const incoming=orders.filter(o=>o.status!=='delivered'&&o.status!=='deleted');
  const delivered=orders.filter(o=>o.status==='delivered');

  totalOrders.innerText=orders.length;
  totalRevenue.innerText=orders.reduce((s,o)=>s+(o.total||0),0);

  incomingEl.innerHTML=incoming.map(o=>card(o,true)).join('');
  deliveredEl.innerHTML=delivered.map(o=>card(o,false)).join('');
}

function card(o,isIncoming){
  return `
  <div class="order-card bg-gray-900 border ${isIncoming?'border-amber-400':'border-gray-700'}">
    <div class="flex justify-between">
      <div>
        <span class="order-type-badge order-type-${o.orderType}">${o.orderType}</span>
        <div class="font-bold">${o.customerName}</div>
        ${o.orderType==='dinein'?`<div>Table: ${o.tableNumber}</div>`:''}
      </div>
      <div class="font-bold text-amber-200">₹${o.total}</div>
    </div>
    <ul class="mt-3 text-sm">
      ${o.items.map(i=>`<li>• ${i.qty} × ${i.name}</li>`).join('')}
    </ul>
    <div class="mt-3 flex gap-2">
      ${isIncoming?`
        <button onclick="updateStatus('${o._id}','delivered')" class="bg-green-600 px-3 py-1 rounded">Delivered</button>`:''}
      <button onclick='bluetoothPrint(${JSON.stringify(o)})'
        class="bg-teal-400 text-black px-3 py-1 rounded font-bold">Print</button>
    </div>
  </div>`;
}

/* ================= RAW BT PRINT ================= */
function bluetoothPrint(order){
  let text='MUGHLAI POINT\n';
  text+='------------------------------\n';
  text+=`Customer: ${order.customerName}\n`;
  if(order.tableNumber) text+=`Table: ${order.tableNumber}\n`;
  text+='------------------------------\n';
  order.items.forEach(i=>{
    text+=`${i.qty} x ${i.name} ₹${i.price}\n`;
  });
  text+='------------------------------\n';
  text+=`TOTAL: ₹${order.total}\n\n`;

  const uri='rawbt:'+encodeURIComponent(text);
  window.location.href=uri;
}

/* ================= LIVE ================= */
const incomingEl=document.getElementById('incoming');
const deliveredEl=document.getElementById('delivered');
datePicker.onchange=()=>fetchOrders(datePicker.value);
socket.on('newOrder',()=>fetchOrders(datePicker.value));
socket.on('orderUpdated',()=>fetchOrders(datePicker.value));
fetchOrders(datePicker.value);
</script>

</body>
</html>
