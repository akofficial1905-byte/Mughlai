<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mughlai Point â€” Manager Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .order-type-badge { font-size:11px; font-weight:600; border-radius:999px; padding:2px 10px; margin-right:6px }
    .order-type-dinein { background:#fbbf24; color:#222; }
    .order-type-takeaway { background:#34d399; color:#222; }
    .order-type-delivery { background:#60a5fa; color:#fff; }

    .insight-label { color:#b45309; font-weight:600; font-size:0.95rem; }
    .insight-select, .insight-input {
      font-weight:600; font-size:0.9rem;
      background:#fffbe8; color:#7c4700;
      border:2px solid #fbbf24;
      border-radius:999px;
      padding:6px 14px;
    }

    .tab-btn {
      padding:.45rem 1.1rem;
      font-size:.8rem;
      font-weight:600;
      border-radius:999px;
      border:1px solid rgb(251,191,36);
      color:rgb(252,211,77);
      background:#0f172a;
    }
    .tab-btn-active {
      background:#fbbf24;
      color:#000;
    }

    @media(max-width:700px){
      .max-w-7xl{max-width:100vw;padding:10px}
    }
  </style>
</head>

<body class="bg-gradient-to-b from-slate-900 via-gray-900 to-black text-gray-100 min-h-screen">

<div class="max-w-7xl mx-auto p-6">

<header class="flex justify-between items-center mb-4">
  <div>
    <h1 class="text-2xl md:text-4xl font-extrabold text-amber-300">Mughlai Point â€” Manager</h1>
    <p class="text-xs text-gray-400">Daily live orders â€¢ dashboards â€¢ print</p>
  </div>
  <a href="/index.html" class="px-4 py-2 bg-gray-800 rounded-full text-sm">Customer View</a>
</header>

<div class="flex gap-2 mb-4">
  <button id="tabOrders" class="tab-btn tab-btn-active">Orders</button>
  <button id="tabAnalytics" class="tab-btn">Analytics & Insights</button>
</div>

<!-- ORDERS -->
<div id="ordersSection">

  <div class="bg-gray-800 rounded-xl p-4 flex flex-col md:flex-row justify-between gap-3">
    <div class="flex items-center gap-2">
      <label class="text-yellow-300 font-bold text-sm">Select Date:</label>

      <!-- âœ… DATE PICKER FIXED -->
      <input
        id="datePicker"
        type="date"
        class="bg-yellow-50 border-2 border-yellow-500
               px-3 py-2
               text-sm md:text-base
               font-bold text-gray-900
               rounded-lg
               focus:outline-none focus:ring-2 focus:ring-yellow-400"
      />
    </div>

    <div class="text-right text-sm">
      <div>Total Orders: <span id="totalOrders" class="text-amber-300 font-bold">0</span></div>
      <div>Revenue: â‚¹<span id="totalRevenue" class="text-green-300 font-bold">0</span></div>
      <div class="flex gap-2 justify-end mt-1">
        <span class="order-type-badge order-type-dinein">Dine-in: <span id="countDinein">0</span></span>
        <span class="order-type-badge order-type-takeaway">Takeaway: <span id="countTakeaway">0</span></span>
        <span class="order-type-badge order-type-delivery">Delivery: <span id="countDelivery">0</span></span>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
    <section>
      <h2 class="text-yellow-200 font-semibold mb-2">ðŸŸ¡ Incoming Orders</h2>
      <div id="incoming"></div>
    </section>
    <section>
      <h2 class="text-green-300 font-semibold mb-2">ðŸŸ¢ Delivered Orders</h2>
      <div id="delivered"></div>
    </section>
  </div>
</div>

<!-- ANALYTICS -->
<div id="analyticsSection" class="hidden mt-6">
  <!-- dashboard + insights untouched -->
</div>

</div>

<script>
const socket = io();

/* ===========================
   LOCAL DATE HELPERS (FIX)
=========================== */
function formatLocalDateYYYYMMDD(d){
  return d.getFullYear() + "-" +
    String(d.getMonth()+1).padStart(2,'0') + "-" +
    String(d.getDate()).padStart(2,'0');
}
function getTodayLocalISO(){
  return formatLocalDateYYYYMMDD(new Date());
}
function getLocalDateFromISO(iso){
  if(!iso) return '';
  return formatLocalDateYYYYMMDD(new Date(iso));
}

/* ===========================
   TABS
=========================== */
const tabOrders=document.getElementById("tabOrders");
const tabAnalytics=document.getElementById("tabAnalytics");
const ordersSection=document.getElementById("ordersSection");
const analyticsSection=document.getElementById("analyticsSection");

tabOrders.onclick=()=>{
  ordersSection.classList.remove("hidden");
  analyticsSection.classList.add("hidden");
  tabOrders.classList.add("tab-btn-active");
  tabAnalytics.classList.remove("tab-btn-active");
};
tabAnalytics.onclick=()=>{
  analyticsSection.classList.remove("hidden");
  ordersSection.classList.add("hidden");
  tabAnalytics.classList.add("tab-btn-active");
  tabOrders.classList.remove("tab-btn-active");
};

/* ===========================
   ORDERS
=========================== */
const datePicker=document.getElementById("datePicker");
datePicker.value=getTodayLocalISO();

async function fetchOrders(date){
  const res=await fetch("/api/orders?date="+date);
  const orders=await res.json();
  renderOrders(orders);
}

function renderOrders(orders){
  const incoming=orders.filter(o=>o.status!=="delivered" && o.status!=="deleted");
  const delivered=orders.filter(o=>o.status==="delivered");

  document.getElementById("totalOrders").innerText=orders.length;
  document.getElementById("totalRevenue").innerText=orders.reduce((s,o)=>s+o.total,0);

  document.getElementById("incoming").innerHTML=incoming.map(o=>orderCard(o,true)).join("") || "No orders";
  document.getElementById("delivered").innerHTML=delivered.map(o=>orderCard(o,false)).join("") || "No orders";
}

function orderCard(o,isIncoming){
  return `
    <div class="bg-gray-900 border border-gray-700 rounded-xl p-3 mb-3">
      <div class="flex justify-between">
        <div>
          <span class="order-type-badge order-type-${o.orderType}">${o.orderType}</span>
          <b>${o.customerName||"-"}</b>
          <div class="text-xs text-gray-400">${new Date(o.createdAt).toLocaleString()}</div>
        </div>
        <div class="font-bold text-amber-200">â‚¹${o.total}</div>
      </div>
      <ul class="text-sm mt-2">
        ${o.items.map(i=>`<li>â€¢ ${i.qty} Ã— ${i.name}</li>`).join("")}
      </ul>
    </div>
  `;
}

datePicker.onchange=()=>fetchOrders(datePicker.value);

/* ===========================
   SOCKET UPDATES (FIXED)
=========================== */
socket.on("newOrder",(o)=>{
  if(getLocalDateFromISO(o.createdAt)===datePicker.value){
    fetchOrders(datePicker.value);
  }
});
socket.on("orderUpdated",()=>fetchOrders(datePicker.value));

/* ===========================
   INIT
=========================== */
window.addEventListener("DOMContentLoaded",()=>{
  const today=getTodayLocalISO();
  datePicker.value=today;
  fetchOrders(today);
});
</script>

</body>
</html>
